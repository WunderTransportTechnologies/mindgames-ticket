# ADR-002: Stripe決済基盤の統合

## ステータス

- [x] Accepted (承認済み)

**日付:** 2025-11-01
**関連PR:** #16

---

## コンテキスト

### 現状の問題

mindgames団体のイベントチケット販売ECシステムにおいて、決済機能が未実装である。チケット購入フローを完成させるためには、信頼性の高い決済プロバイダーの統合が必要不可欠。

### 解決したい課題

- クレジットカード決済の実装
- 決済完了後のチケット発行フロー
- Webhookによる非同期処理
- セキュアな決済情報の管理
- PCI DSS準拠

### 制約条件

- Next.js 15 (App Router) との互換性
- TypeScriptによる型安全な実装
- サーバーレス環境（Vercel）での動作
- 日本円（JPY）対応
- テスト環境での動作確認が容易

---

## 検討した選択肢

### 選択肢1: Stripe

**概要:**
世界的に広く使われている決済プラットフォーム。開発者向けAPIが充実しており、Next.jsとの統合が容易。

**メリット:**
- 充実したドキュメントとSDK
- Next.jsとの公式統合サポート
- Webhook機能による非同期処理
- テストモードでの開発が容易
- 豊富な決済手段（クレジットカード、Apple Pay、Google Payなど）
- PCI DSS準拠（カード情報を自サーバーで保持しない）
- 日本語ドキュメントとサポート
- Stripe CLIによるローカル開発支援

**デメリット:**
- 決済手数料（3.6%）
- 海外サービスのため、円転換時の為替リスク

### 選択肢2: Square

**概要:**
POSシステムでも有名な決済プラットフォーム。

**メリット:**
- シンプルなAPI
- 決済手数料が比較的低い（3.25%〜）
- 日本でのサポート

**デメリット:**
- ドキュメントがStripeほど充実していない
- Next.js統合の事例が少ない
- Webhook機能が限定的

### 選択肢3: PayPal

**概要:**
世界的に利用されている決済サービス。

**メリット:**
- グローバルでの認知度が高い
- 多様な決済手段

**デメリット:**
- API設計が複雑
- ドキュメントの質が低い
- 開発者体験が他社に劣る
- Next.jsとの統合事例が少ない

---

## 決定内容

### 採用する選択肢

**Stripe** を決済プロバイダーとして採用する。

### 決定の理由

1. **開発者体験の優秀さ**: TypeScript SDKの型定義が充実しており、Next.js App Routerとの統合が容易
2. **Webhook機能**: 決済完了などのイベントを非同期で受け取れる仕組みが充実
3. **テスト環境**: テストモードでの開発が容易で、Stripe CLIによるローカルWebhookテストが可能
4. **セキュリティ**: PCI DSS準拠で、カード情報を自サーバーで保持する必要がない
5. **拡張性**: 将来的にApple Pay、Google Payなどの追加決済手段への対応が容易
6. **ドキュメント**: 日本語を含む充実したドキュメントとサンプルコード

---

## 結果

### 期待される効果

- セキュアな決済フローの実装
- チケット購入完了後の自動発行フロー（Webhook経由）
- 開発・テスト環境での迅速な検証
- PCI DSS準拠によるセキュリティリスクの低減

### トレードオフ

- **決済手数料**: 3.6%の手数料が発生（他サービスと比較してやや高め）
- **海外サービス依存**: 為替リスクやサービス規約変更のリスク

### 技術的負債・リスク

**技術的負債:**
- 現時点ではダミーデータでCheckout Sessionを作成しているため、今後データベース統合が必要
- チケット発行処理（Webhook内）が未実装

**リスク:**
- Stripe APIバージョンアップ時の互換性対応
- Webhook遅延やタイムアウト時のリトライ処理が未実装

**軽減策:**
- Stripe APIバージョンを明示的に指定（`2024-11-20.acacia`）
- Webhook署名検証を必須実装
- 今後、冪等性キーの実装を検討

### 移行計画

Phase 2の次のタスクとして、以下を実装予定:
1. データベーススキーマ拡張（orders, paymentsテーブル）
2. Webhook内のチケット発行処理実装
3. メール送信（Resend）との統合

---

## 参考資料

- [Stripe 公式ドキュメント](https://stripe.com/docs)
- [Stripe Node.js SDK](https://stripe.com/docs/api/node)
- [Stripe Webhooks ガイド](https://stripe.com/docs/webhooks)
- [Next.js と Stripe の統合例](https://github.com/vercel/next.js/tree/canary/examples/with-stripe-typescript)
- [Stripe CLI](https://stripe.com/docs/stripe-cli)

---

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|-------|
| 2025-11-01 | 初版作成 | Claude Code |
