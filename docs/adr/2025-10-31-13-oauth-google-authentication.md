# ADR-001: OAuth (Google) による認証方式の採用

## ステータス

- [x] Accepted (承認済み)

**日付:** 2025-10-31
**関連PR:** #13

---

## コンテキスト

### 現状の問題

mindgamesチケット販売システムにユーザー認証機能を実装する必要がある。ユーザーはチケット購入、購入履歴閲覧、QRコード付きチケット取得などの機能を利用するため、安全かつ使いやすい認証基盤が必須。

### 解決したい課題

1. **コンバージョン率の最大化**: チケット購入までの障壁を最小限に抑える
2. **ユーザビリティ**: アカウント作成・ログインの手間を削減
3. **セキュリティ**: ユーザー情報と決済情報を安全に管理
4. **実装コスト**: MVP段階で迅速に実装できる方法を選定
5. **メンテナンス性**: 長期的に運用しやすい認証基盤

### 制約条件

- Next.js 15 App Router + TypeScript環境
- Drizzle ORM + Neon PostgreSQL使用
- Better Auth（TypeScriptネイティブ認証ライブラリ）を採用予定
- MVP段階での実装（リソース・時間が限定的）

---

## 検討した選択肢

### 選択肢1: OAuth (Google) のみ

**概要:**
Googleアカウントを使用したソーシャルログイン。ユーザーは既存のGoogleアカウントで1クリック認証。

**メリット:**
- **最高のコンバージョン率**: 1クリックでログイン完了、入力フォームなし
- **実装コスト最小**: OAuth統合のみで完結、パスワード管理不要
- **セキュリティ**: 認証処理をGoogleに委任、パスワード漏洩リスクなし
- **ユーザビリティ**: スマートフォン（特にAndroid）で自動ログイン済み
- **開発速度**: Better AuthでのGoogle OAuth実装は数行で完了

**デメリット:**
- Googleアカウント未保持ユーザーを取りこぼす可能性（ただし日本では90%以上がGoogleアカウント保持と推定）
- サードパーティ（Google）への依存
- プライバシー懸念のあるユーザーが利用を避ける可能性

### 選択肢2: Magic Link (Email) のみ

**概要:**
メールアドレスを入力し、届いたリンクをクリックしてログインするパスワードレス認証。

**メリット:**
- パスワード不要でセキュア
- Googleアカウント不要
- パスワード管理の負担なし

**デメリット:**
- **メール到達待ち**: ログインまでに時間がかかる（購入意欲が冷める可能性）
- **メールボックスを開く手間**: モバイルでは特に面倒
- **メール到達性**: スパムフィルタやメールサーバー問題で届かない可能性
- **実装コスト**: メール送信基盤（Resend）の統合が必要
- OAuthより実装工数が多い

### 選択肢3: OAuth (Google) + Magic Link 両方

**概要:**
GoogleログインとMagic Linkの両方を提供し、ユーザーが選択。

**メリット:**
- 全てのユーザーをカバー
- ユーザーの選択肢を増やせる

**デメリット:**
- **実装コスト大**: 2つの認証フローを実装・メンテナンス
- **UI複雑化**: 認証方法の選択肢が増え、ユーザーを混乱させる可能性
- **MVP段階では過剰**: 初期段階で両方必要かは不明
- テストケースが倍増

### 選択肢4: Email + Password (従来型)

**概要:**
メールアドレスとパスワードを使った伝統的な認証方式。

**メリット:**
- 多くのユーザーが慣れている
- サードパーティへの依存なし

**デメリット:**
- **コンバージョン率低下の最大要因**: 入力項目多数、離脱率上昇
- **パスワード忘れ多発**: サポートコスト増、機会損失
- **セキュリティリスク**: パスワード管理（ハッシュ化、リセットフロー）の実装負担
- **実装・運用コスト大**: パスワードリセット、セキュリティ対策など
- **Better Authの思想に反する**: 「パスワードは悪」という設計思想

---

## 決定内容

### 採用する選択肢

**選択肢1: OAuth (Google) のみ**を採用する。

### 決定の理由

1. **コンバージョン率最大化**: チケット販売サイトでは購入完了までの障壁を最小化することが最優先。Googleログインは1クリックで完了し、最もコンバージョン率が高い。

2. **実装速度**: MVP段階では迅速なリリースが重要。OAuthは実装が最も簡単で、Better Authでは数行のコードで完結。

3. **セキュリティ**: 認証処理をGoogleに委任することで、パスワード管理の負担とリスクを排除。

4. **ユーザーカバレッジ**: 日本のスマートフォンユーザーの大多数がGoogleアカウントを保持（Android標準、iPhoneでもGmail利用率高）。

5. **段階的拡張**: 将来的にMagic Linkや他のOAuthプロバイダー（Apple, GitHub）を追加する余地を残す。

6. **Geminiの推奨**: 技術調査の結果、ECサイトのベストプラクティスとして**OAuth → Magic Link**の順での段階的導入が推奨された。

---

## 結果

### 期待される効果

- **高いコンバージョン率**: 購入までの障壁削減により、チケット販売数増加を期待
- **優れたUX**: ワンクリック認証でストレスフリーなユーザー体験
- **開発速度向上**: シンプルな実装でMVPを迅速にリリース
- **セキュリティ向上**: Google OAuth 2.0の堅牢なセキュリティを活用
- **運用コスト削減**: パスワード忘れ対応などのサポートコスト削減

### トレードオフ

- **Googleアカウント未保持ユーザーの排除**: 極少数だが取りこぼす可能性あり
  - **対策**: フィードバックを収集し、必要であればPhase 2でMagic Linkを追加
- **サードパーティ依存**: Googleのサービス障害時に影響を受ける
  - **対策**: Googleの高可用性（99.9%以上）を信頼、将来的に複数プロバイダーで冗長化

### 技術的負債・リスク

- **単一プロバイダー依存**: 現時点ではGoogle一択
  - **軽減策**: Better Authは複数プロバイダー対応が容易なため、必要時に迅速に追加可能
- **プライバシー懸念**: ソーシャルログインを避けるユーザーへの対応
  - **軽減策**: ユーザーフィードバックを監視し、需要があればMagic Link追加を検討

### 移行計画

**Phase 1（現在 - MVP）:**
- OAuth (Google) のみを実装
- ユーザーフィードバック収集

**Phase 2（将来的）:**
- 必要に応じてMagic Link (Email) を追加
- Apple Login追加（iPhoneユーザー向け）
- GitHubログイン追加（開発者向けイベント用）

**Phase 3（長期的）:**
- 複数認証方法の統合（アカウント連携機能）
- 2要素認証（2FA）の検討

---

## 参考資料

- [Better Auth 公式ドキュメント](https://www.better-auth.com/)
- [Gemini技術調査結果](チケット販売サイトにおける認証方法の推奨事項)
- [docs/TECH_STACK.md](../TECH_STACK.md) - Better Auth選定理由
- [docs/NEXT_STEPS.md](../NEXT_STEPS.md) - Phase 2実装計画
- [OAuth 2.0 仕様](https://oauth.net/2/)
- [Google Identity Platform](https://developers.google.com/identity)

---

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|---------|-------|
| 2025-10-31 | 初版作成 - OAuth (Google) 認証方式を採用 | Claude Code |
